# Архитектура Telegram Mini App

## Общее описание
Проект представляет собой Telegram Mini App для P2P-торговли криптовалютами. Приложение состоит из двух основных частей: фронтенд (клиентская часть) и бекенд (серверная часть).

## Структура проекта

```
Mini-app/
├── index.html                 # Главная HTML-страница
├── script.js                  # Основная логика фронтенда
├── component-loader.js        # Загрузчик компонентов
├── components/                # Компоненты интерфейса
│   ├── selection.html         # Экран выбора (покупка/продажа/профиль)
│   ├── buy-form.html          # Форма покупки
│   ├── sell-form.html         # Форма продажи
│   ├── profile.html           # Профиль пользователя
│   └── header.html            # Заголовок (опционально)
├── backend/
│   └── TelegramMiniAppBackend/
│       ├── Program.cs         # Точка входа в приложение
│       ├── Controllers/       # Контроллеры API
│       ├── Models/            # Модели данных
│       ├── Services/          # Бизнес-логика
│       ├── Data/              # Работа с базой данных
│       ├── app.db             # SQLite база данных
│       └── *.csproj           # Файл проекта
```

## Фронтенд (Клиентская часть)

### Технологии
- HTML5
- CSS3 (Bootstrap 5.3.3)
- JavaScript (ES6+)
- Telegram Web App API
- Bootstrap Icons

### Архитектура фронтенда

#### 1. Component Loader System
Файл: `component-loader.js`
- Класс `ComponentLoader` отвечает за динамическую загрузку HTML-компонентов
- Компоненты загружаются асинхронно по HTTP
- После загрузки компонентов вставляются в соответствующие placeholder-элементы
- Скрипты из компонентов выполняются отдельно для безопасности

#### 2. Основные компоненты
- `selection.html`: Главный экран с выбором действия (покупка, продажа, профиль)
- `buy-form.html`: Форма для создания заявок на покупку
- `sell-form.html`: Форма для создания заявок на продажу
- `profile.html`: Личный кабинет пользователя с отображением ордеров

#### 3. Навигация
- Файл: `script.js`
- Функция `navigateTo(target)` отвечает за переход между экранами
- Используется система классов для отображения/скрытия экранов
- Анимации переходов реализованы через CSS-классы `fade-out`
- Переменная `currentScreen` отслеживает текущий активный экран

#### 4. Взаимодействие с Telegram
- Используется Telegram Web App API для получения данных пользователя
- Взаимодействие с Telegram Mini App SDK для получения данных авторизации

#### 5. Работа с API
- Функции `submitForm(type)` отправляют данные форм на бекенд
- Функция `updateProfile()` загружает и отображает данные пользователя и его ордера
- Используется REST API для взаимодействия с сервером
- Адрес бекенда задается в переменной `BACKEND_URL`

## Бекенд (Серверная часть)

### Технологии
- ASP.NET Core (NET 8.0)
- Entity Framework Core
- SQLite (локальная база данных)
- Telegram.Bot SDK
- Swagger (для документации API)

### Архитектура бекенда

#### 1. Структура приложения

##### Program.cs
- Точка входа в приложение
- Регистрация сервисов через Dependency Injection
- Настройка CORS, контроллеров и Swagger
- Подключение к SQLite базе данных
- Регистрация Telegram бота и фонового сервиса

##### Controllers
- `OrderController`: CRUD-операции для ордеров (покупка/продажа)
- `ClientController`: Управление информацией о клиентах
- `SystemController`: Системные операции (health check)

#### 2. Модели данных
- `Order`: Модель ордера (покупка/продажа) с полями: ID, пользователь, тип, валюта, банк, сумма, контакты, статус и т.д.
- `ClientModel`: Модель клиента с Telegram ID, именем пользователя и полным именем
- `OrderStatus`: Статусы ордера (создан, в работе, завершен, отменен)

#### 3. Сервисы
- `ClientService`: Управление информацией о клиентах
- `TelegramBotService`: Интеграция с Telegram Bot API, отправка уведомлений
- `TelegramBotBackgroundService`: Фоновый сервис для обработки обновлений от Telegram
- `OrderMapper`: Отображение форм ордеров в модель ордера

#### 4. Работа с базой данных
- Используется Entity Framework Core с SQLite
- Модель данных определена в `AppDbContext`
- Миграции не используются, база создается автоматически при первом запуске

### API endpoints

#### Order API
- `POST /api/Order/buy_order` - Создание ордера на покупку
- `POST /api/Order/sell_order` - Создание ордера на продажу
- `PUT /api/Order/order/{id}/status` - Обновление статуса ордера
- `GET /api/Order` - Получение всех ордеров
- `GET /api/Order/{id}` - Получение ордера по ID
- `GET /api/Order/orders/user/{id}` - Получение ордеров пользователя
- `GET /api/Order/orders/user/{id}/last-day` - Получение ордеров пользователя

#### Client API
- `POST /api/Client` - Создание/обновление клиента
- `GET /api/Client/{telegramId}` - Получение клиента по Telegram ID
- `GET /api/Client/exists/{telegramId}` - Проверка существования клиента
- `GET /api/Client` - Получение списка клиентов
- `PUT /api/Client/{telegramId}` - Обновление информации о клиенте
- `DELETE /api/Client/{telegramId}` - Удаление клиента

#### System API
- `GET /live` - Health check endpoint

## Взаимодействие между фронтендом и бекендом

Фронтенд и бекенд взаимодействуют через REST API:
1. Фронтенд отправляет HTTP-запросы на бекенд
2. Бекенд обрабатывает запросы и возвращает JSON-ответы
3. Фронтенд обрабатывает ответы и обновляет UI

### Поток работы:
1. При загрузке приложения фронтенд загружает компоненты
2. Пользователь авторизуется через Telegram Web App
3. При создании ордера фронтенд отправляет данные на бекенд
4. Бекенд проверяет данные, сохраняет в базу и уведомляет администраторов через Telegram бота
5. Пользователь может просматривать свои ордера через профиль

## Безопасность
- Проверка существования клиента перед созданием ордера
- Использование Telegram WebApp для получения верифицированных данных пользователя
- CORS настроен для разрешения запросов с любого источника (в целях разработки)

## Деплоймент
- Бекенд - ASP.NET Core приложение, может быть задеплоено на любой сервер, поддерживающий .NET 8
- Фронтенд - статические HTML/JS/CSS файлы, могут быть размещены на любом HTTP-сервере или CDN